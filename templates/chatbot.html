{% extends 'base.html' %}

{% block title %}Sheryl{% endblock %}

{% block styles %}
<style>
    body, html {
      height: 100%;
    }

    .messages-box {
      flex: 1;
      overflow-y: auto;
    }

    .messages-list {
      padding-left: 0;
    }

    .message {
      margin-bottom: 15px;
      list-style: none;
    }

    .message-text {
      padding: 10px;
      border-radius: 5px;
    }

    .sent {
      background-color: #dcf8c6;
      align-self: flex-end;
    }

    .received {
      background-color: #f1f0f0;
      align-self: flex-start;
    }

    .message-form {
      display: flex;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 10px;
      background-color: #f8f9fa;
    }

    .message-input {
      flex: 1;
      border-radius: 0;
      border-right: none;
      resize: none;
    }

    .btn-send {
      border-radius: 0;
    }

    .chat-container {
      height: 100%;
      display: flex;
      flex-direction: column;
    }
  </style>
{% endblock %}


{% block content %}
<div class="chat-container">
  <div class="card flex-grow-1">
    {% if user.is_authenticated %}
    <div class="card-header bg-primary text-white"><b>Welcome, {{user.username}} </b><a style="color: yellow" href="logout">Logout</a></div>

    {% else %}
    <div class="card-header bg-primary text-white"><a style="color: yellow" href="login">Login</a>   <a style="color: yellow" href="register">Register</a></div>
    {% endif %}
    <div class="card-body messages-box">
      
      <ul class="list-unstyled messages-list">

        {% for chat in chats %}
          {% if chat.user == request.user %}<!-- Extra security check: make sure user that is currently logged in, so we can show. 
                                            to ensure that there's no data leak or no problem in showing the right message to the right user. -->
            <li class="message sent">
              <div class="message-text">
                <div class="message-sender">
                  <b>You</b>
                </div>
                <div class="message-content">
                  {{chat.message}}
                </div>
              </div>
            </li>   
            
            <li class="message received">
              <div class="message-text">
                <div class="message-sender">
                  <b>Sheryl</b>
                </div>
                <div class="message-content">
                  {{chat.response}}
                </div>
              </div>
            </li>
          {% endif %}
        {% endfor %}

        <!-- Here is where the user's message (messageItem) will be appended -->
      </ul>
    </div>
    <br><br>
    <br><br>
    <br><br>
  </div>
  <form class="message-form">
    {%csrf_token%}
    <div class="input-group">
      <textarea class="form-control message-input" placeholder="Type your message..."></textarea>
      <div class="input-group-append">
        <button type="submit" class="btn btn-primary btn-send">Send</button>
      </div>
    </div>
  </form>
</div>

<script>
  //var sessionId = "{{ sessionId|escapejs }}"; // prevent potential cross-site scripting (XSS) attacks
  const token = "{{ token }}"; 
  const messagesList = document.querySelector('.messages-list');
  const messageForm = document.querySelector('.message-form');
  const messageInput = document.querySelector('.message-input');
  
  messageInput.addEventListener('keydown', (event) => {
    if (event.key === 'Enter') {
      if (!event.shiftKey) {
        event.preventDefault();
        // If the Shift key is not being pressed, submit the form.
        messageForm.dispatchEvent(new Event('submit'));
      }
      // If Shift is being pressed along with Enter, let the default happen (newline).
    }
  });

  messageForm.addEventListener('submit', (event) => {
    event.preventDefault();   // prevent refreshing the current page when the submit button is clicked

    const message = messageInput.value.trim();
    if (message.length === 0) {
      return;
    }
    console.log(message);

    const messageItem = document.createElement('li');
    messageItem.classList.add('message', 'sent');
    messageItem.innerHTML = `
      <div class="message-text">
        <div class="message-sender">
            <b>You</b>
        </div>
        <div class="message-content">
          ${message}
        </div>
      </div>`;
    messagesList.appendChild(messageItem);

    messageInput.value = '';

    fetch('/api/chat/', {    
      method: 'POST',
      headers: {  'Content-Type': 'application/json', 
                  'Authorization': 'Token ' + token,
                  'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({
        'message': message,
      })
    })
      .then(response => {
        if (!response.ok) { throw new Error(response.status) }
        return response.json()
      })
      .then(data => {
        const response = data.response;       // data is passed back from the service
        const messageItem = document.createElement('li');
        messageItem.classList.add('message', 'received');
        messageItem.innerHTML = `
        <div class="message-text">
            <div class="message-sender">
              <b>Sheryl</b>
            </div>
            <div class="message-content">
              ${response}
            </div>
        </div>
        `;
        messagesList.appendChild(messageItem);
      
      })
      .catch(error => console.error('Error:', error));
  });
</script>
{% endblock %}